{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Registrar Consumo de Alimento" %}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-utensils me-2"></i>
                {% trans "Registrar Consumo de Alimento" %}
            </h1>
            <p class="text-muted">{% trans "Registro de consumo diario de alimento por lote" %}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'inventario:lista_alimentos' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> {% trans "Volver" %}
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-plus-circle me-2"></i>
                {% trans "Formulario de Registro" %}
            </h5>
        </div>
        <div class="card-body">
            <form method="post" id="consumoForm">
                {% csrf_token %}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="fecha" class="form-label">{% trans "Fecha" %}</label>
                        <input type="date" class="form-control" id="fecha" name="fecha" value="{{ fecha_actual|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="alimento" class="form-label">{% trans "Alimento" %}</label>
                        <select class="form-select" id="alimento" name="alimento" required>
                            <option value="">{% trans "Seleccione un alimento" %}</option>
                            {% for alimento in alimentos %}
                                <option value="{{ alimento.id }}">{{ alimento.nombre }} ({{ alimento.tipo }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="lote" class="form-label">{% trans "Lote" %}</label>
                        <select class="form-select" id="lote" name="lote" required>
                            <option value="">{% trans "Seleccione un lote" %}</option>
                            {% for lote in lotes %}
                                <option value="{{ lote.id }}">{{ lote.codigo }} ({{ lote.galpon }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="cantidad" class="form-label">{% trans "Cantidad (kg)" %}</label>
                        <div class="input-group">
                            <input type="number" step="0.01" min="0.1" class="form-control" id="cantidad" name="cantidad" required>
                            <span class="input-group-text">kg</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="observaciones" class="form-label">{% trans "Observaciones" %}</label>
                    <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
                </div>
                
                <div class="alert alert-info" id="stockInfo" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="stockMessage"></span>
                </div>
                
                <div class="text-end">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back();">
                        {% trans "Cancelar" %}
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> {% trans "Guardar" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>
                {% trans "Información Importante" %}
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <h5 class="alert-heading">{% trans "Recomendaciones para el registro de consumo" %}</h5>
                <ul>
                    <li>{% trans "Registre el consumo diario de cada lote para mantener un seguimiento preciso." %}</li>
                    <li>{% trans "Verifique que la cantidad registrada corresponda al consumo real, no a lo suministrado." %}</li>
                    <li>{% trans "Si observa cambios significativos en el consumo, regístrelo en las observaciones." %}</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Simulación de verificación de stock al seleccionar un alimento
        const alimentoSelect = document.getElementById('alimento');
        const stockInfo = document.getElementById('stockInfo');
        const stockMessage = document.getElementById('stockMessage');
        
        alimentoSelect.addEventListener('change', function() {
            const alimentoId = this.value;
            if (!alimentoId) {
                stockInfo.style.display = 'none';
                return;
            }
            
            // Simulación de datos de stock
            let stockData = {
                '1': { stock: 500, nombre: 'Alimento Inicial' },
                '2': { stock: 750, nombre: 'Alimento Crecimiento' },
                '3': { stock: 1200, nombre: 'Alimento Producción' }
            };
            
            const stock = stockData[alimentoId].stock;
            const nombre = stockData[alimentoId].nombre;
            
            stockMessage.textContent = `${nombre}: ${stock} kg disponibles`;
            stockInfo.style.display = 'block';
            
            if (stock < 100) {
                stockInfo.className = 'alert alert-danger';
                stockMessage.textContent += ' (¡Stock bajo!)';
            } else {
                stockInfo.className = 'alert alert-info';
            }
        });
        
        // Validación del formulario
        const form = document.getElementById('consumoForm');
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const cantidad = document.getElementById('cantidad').value;
            const alimentoId = alimentoSelect.value;
            
            if (!alimentoId) {
                alert('{% trans "Por favor seleccione un alimento" %}');
                return;
            }
            
            // Simulación de datos de stock
            let stockData = {
                '1': { stock: 500 },
                '2': { stock: 750 },
                '3': { stock: 1200 }
            };
            
            const stock = stockData[alimentoId].stock;
            
            if (parseFloat(cantidad) > stock) {
                alert('{% trans "La cantidad ingresada supera el stock disponible" %}');
                return;
            }
            
            // Si todo está bien, enviar el formulario
            this.submit();
        });
    });
</script>
{% endblock %}
