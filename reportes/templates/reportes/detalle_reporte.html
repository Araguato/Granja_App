{% extends 'core/base.html' %}
{% load static %}

{% block title %}Detalle de Reporte | App Granja{% endblock %}

{% block extra_css %}
<style>
    .report-detail {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        padding: 30px;
        margin-bottom: 30px;
    }
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e3e6f0;
    }
    .report-actions {
        margin-top: 30px;
        display: flex;
        gap: 10px;
    }
    .report-field {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    .report-field:last-child {
        border-bottom: none;
    }
    .report-field label {
        font-weight: 600;
        color: #5a5c69;
        display: inline-block;
        width: 180px;
    }
    .report-field span {
        color: #4e73df;
    }
    .module {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        margin-bottom: 30px;
        padding: 20px;
    }
    .module h2 {
        color: #4e73df;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e3e6f0;
    }
    table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
    }
    table th {
        background-color: #f8f9fc;
        color: #4e73df;
        padding: 12px;
        text-align: left;
    }
    table td {
        padding: 12px;
        border-bottom: 1px solid #e3e6f0;
    }
    table tr:hover {
        background-color: #f8f9fc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="report-header">
        <h1><i class="fas fa-file-alt me-2"></i>Detalle del Reporte</h1>
        <a href="{% url 'reportes:panel_reportes' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver al Panel
        </a>
    </div>
</div>

<div class="report-detail">
    <h2>{{ reporte.titulo }}</h2>
    
    <div class="report-field">
        <label>Tipo:</label>
        <span>{{ reporte.get_tipo_reporte_display }}</span>
    </div>
    
    <div class="report-field">
        <label>Periodo:</label>
        <span>{{ reporte.fecha_inicio|date:"d/m/Y" }} - {{ reporte.fecha_fin|date:"d/m/Y" }}</span>
    </div>
    
    <div class="report-field">
        <label>Formato:</label>
        <span>{{ reporte.get_formato_display }}</span>
    </div>
    
    <div class="report-field">
        <label>Generado por:</label>
        <span>{{ reporte.usuario_generador.get_full_name|default:reporte.usuario_generador.username }}</span>
    </div>
    
    <div class="report-field">
        <label>Fecha de generación:</label>
        <span>{{ reporte.fecha_generacion|date:"d/m/Y H:i" }}</span>
    </div>
    
    {% if reporte.archivo %}
    <div class="report-field">
        <label>Archivo:</label>
        <span>{{ reporte.archivo.name|cut:"reportes/" }}</span>
    </div>
    {% endif %}
    
    <div class="report-actions">
        <a href="{% url 'reportes:descargar_reporte' reporte.id %}" class="button">Descargar Reporte</a>
        <form method="post" action="{% url 'reportes:eliminar_reporte' reporte.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="button" onclick="return confirm('¿Está seguro de eliminar este reporte?');">Eliminar Reporte</button>
        </form>
    </div>
</div>

{% if reporte.parametros %}
<div class="module">
    <h2>Parámetros del Reporte</h2>
    <table>
        <thead>
            <tr>
                <th>Parámetro</th>
                <th>Valor</th>
            </tr>
        </thead>
        <tbody>
            {% for key, value in reporte.parametros.items %}
            <tr>
                <td>{{ key }}</td>
                <td>{{ value }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if reporte.formato == 'CSV' and reporte.archivo %}
<div class="report-preview">
    <h2>Vista Previa</h2>
    <p><em>Vista previa disponible solo para reportes en formato CSV.</em></p>
    
    <div id="csv-preview">
        <p>Cargando vista previa...</p>
    </div>
    
    <script>
        // Script simple para cargar una vista previa del CSV
        fetch('{% url "reportes:descargar_reporte" reporte.id %}')
            .then(response => response.text())
            .then(data => {
                const lines = data.split('\n');
                let tableHtml = '<table class="preview-table">';
                
                lines.forEach((line, index) => {
                    if (line.trim()) {
                        const cells = line.split(',');
                        tableHtml += '<tr>';
                        
                        cells.forEach(cell => {
                            if (index === 0) {
                                tableHtml += `<th>${cell}</th>`;
                            } else {
                                tableHtml += `<td>${cell}</td>`;
                            }
                        });
                        
                        tableHtml += '</tr>';
                    }
                });
                
                tableHtml += '</table>';
                document.getElementById('csv-preview').innerHTML = tableHtml;
            })
            .catch(error => {
                document.getElementById('csv-preview').innerHTML = '<p>Error al cargar la vista previa.</p>';
                console.error('Error:', error);
            });
    </script>
</div>
{% endif %}
{% endblock %}
