{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}">
<style>
    .group-card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
    }
    .group-card.selected {
        border-color: #79aec8;
        background-color: #f5fafd;
    }
    .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .group-stats {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 10px;
    }
    .group-actions {
        margin-top: 10px;
    }
    .checkbox-container {
        display: flex;
        align-items: center;
    }
    .checkbox-container input[type="checkbox"] {
        margin-right: 10px;
    }
    .badge {
        display: inline-block;
        padding: 3px 7px;
        font-size: 12px;
        font-weight: bold;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        background-color: #777;
        border-radius: 10px;
        margin-left: 5px;
    }
    .badge-primary { background-color: #417690; }
    .badge-success { background-color: #5cb85c; }
    .badge-info { background-color: #5bc0de; }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
    &rsaquo; <a href="{% url 'admin:avicola_userprofile_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
    &rsaquo; <a href="{% url 'admin:avicola_userprofile_change' user.pk %}">{{ user.username }}</a>
    &rsaquo; {% trans 'Gestionar Grupos' %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <form method="post" id="group-form">
        {% csrf_token %}
        <div class="module aligned">
            <h2>{% trans "Gestionar Grupos para" %}: {{ user.username }}</h2>
            <p class="help">
                {% trans "Seleccione los grupos a los que desea que pertenezca este usuario. El usuario heredar√° todos los permisos asignados a cada grupo seleccionado." %}
            </p>
            
            <div class="form-row">
                <div>
                    <h3>{% trans "Grupos Disponibles" %}</h3>
                    {% for group_info in groups_info %}
                        <div class="group-card {% if group_info.is_member %}selected{% endif %}">
                            <div class="group-header">
                                <div class="checkbox-container">
                                    <input type="checkbox" name="groups" value="{{ group_info.id }}" id="group_{{ group_info.id }}" 
                                        {% if group_info.is_member %}checked{% endif %}>
                                    <label for="group_{{ group_info.id }}">
                                        <strong>{{ group_info.name }}</strong>
                                        {% if group_info.is_member %}
                                            <span class="badge badge-primary">{% trans "Miembro" %}</span>
                                        {% endif %}
                                    </label>
                                </div>
                            </div>
                            <div class="group-stats">
                                <span class="badge badge-info">{{ group_info.users_count }} {% trans "usuarios" %}</span>
                                <span class="badge badge-success">{{ group_info.permissions_count }} {% trans "permisos" %}</span>
                            </div>
                            <div class="group-actions">
                                <a href="{% url 'admin:auth_group_change' group_info.id %}" class="button" target="_blank">
                                    {% trans "Ver Detalles" %}
                                </a>
                                <a href="#" class="button" onclick="window.open('{% url 'admin:auth_group_change' group_info.id %}', '_blank'); return false;">
                                    {% trans "Editar Permisos" %}
                                </a>
                            </div>
                        </div>
                    {% empty %}
                        <p>{% trans "No hay grupos disponibles." %}</p>
                    {% endfor %}
                </div>
            </div>
            
            <div class="submit-row">
                <input type="submit" value="{% trans 'Guardar' %}" class="default" name="_save">
                <a href="{% url 'admin:avicola_userprofile_changelist' %}" class="button">{% trans "Cancelar" %}</a>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Hacer que toda la tarjeta sea clickeable para seleccionar el checkbox
        const groupCards = document.querySelectorAll('.group-card');
        groupCards.forEach(function(card) {
            card.addEventListener('click', function(e) {
                // No activar si se hizo clic en un enlace o en el checkbox
                if (e.target.tagName === 'A' || e.target.tagName === 'INPUT') {
                    return;
                }
                
                // Encontrar el checkbox dentro de esta tarjeta
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                
                // Actualizar la clase de la tarjeta
                if (checkbox.checked) {
                    this.classList.add('selected');
                } else {
                    this.classList.remove('selected');
                }
            });
        });
    });
</script>
{% endblock %}
