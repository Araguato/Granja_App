{% extends 'core/base.html' %}

{% block title %}Detalles del Respaldo - App Granja{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .status-completed {
        background-color: #28a745;
        color: white;
    }
    .status-pending {
        background-color: #ffc107;
        color: #212529;
    }
    .status-in-progress {
        background-color: #17a2b8;
        color: white;
    }
    .status-failed {
        background-color: #dc3545;
        color: white;
    }
    .detail-label {
        font-weight: 600;
        color: #495057;
    }
    .restore-log {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 0.25rem;
    }
    .restore-log-completed {
        background-color: #d4edda;
        border-left: 4px solid #28a745;
    }
    .restore-log-failed {
        background-color: #f8d7da;
        border-left: 4px solid #dc3545;
    }
    .restore-log-in-progress {
        background-color: #d1ecf1;
        border-left: 4px solid #17a2b8;
    }
    .log-output {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="fas fa-database me-2"></i>Detalles del Respaldo</h1>
        <div class="mb-3">
            <a href="{% url 'respaldos:backup_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver a la Lista
            </a>
            {% if backup.status == 'COMPLETED' and backup.file_exists %}
            <a href="{% url 'respaldos:download_backup' backup.id %}" class="btn btn-success">
                <i class="fas fa-download me-1"></i>Descargar
            </a>
            <a href="{% url 'respaldos:restore_backup' backup.id %}" class="btn btn-warning">
                <i class="fas fa-undo me-1"></i>Restaurar
            </a>
            {% endif %}
            <a href="{% url 'respaldos:delete_backup' backup.id %}" class="btn btn-danger">
                <i class="fas fa-trash me-1"></i>Eliminar
            </a>
        </div>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Información del Respaldo
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">ID:</div>
                    <div class="col-md-8">{{ backup.id }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">Nombre:</div>
                    <div class="col-md-8">{{ backup.name }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">Tipo:</div>
                    <div class="col-md-8">{{ backup.get_backup_type_display }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">Estado:</div>
                    <div class="col-md-8">
                        <span class="badge status-badge status-{{ backup.status|lower }}">
                            {{ backup.get_status_display }}
                        </span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">Tamaño:</div>
                    <div class="col-md-8">{{ backup.size_in_mb }} MB</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">Creado por:</div>
                    <div class="col-md-8">{{ backup.created_by.username|default:"Sistema" }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">Fecha de creación:</div>
                    <div class="col-md-8">{{ backup.created_at|date:"d/m/Y H:i:s" }}</div>
                </div>
                {% if backup.completed_at %}
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">Fecha de finalización:</div>
                    <div class="col-md-8">{{ backup.completed_at|date:"d/m/Y H:i:s" }}</div>
                </div>
                {% endif %}
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">Archivo:</div>
                    <div class="col-md-8">
                        {% if backup.file_exists %}
                        <i class="fas fa-check-circle text-success me-1"></i>{{ backup.file_name }}
                        {% else %}
                        <i class="fas fa-times-circle text-danger me-1"></i>Archivo no encontrado
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 detail-label">Automático:</div>
                    <div class="col-md-8">
                        {% if backup.is_auto %}
                        <i class="fas fa-check-circle text-success me-1"></i>Sí
                        {% else %}
                        <i class="fas fa-times-circle text-danger me-1"></i>No
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sticky-note me-2"></i>Notas
            </div>
            <div class="card-body">
                {% if backup.notes %}
                <div class="p-3 bg-light rounded">
                    {{ backup.notes|linebreaks }}
                </div>
                {% else %}
                <div class="alert alert-light">
                    <i class="fas fa-info-circle me-2"></i>No hay notas para este respaldo.
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if backup.status == 'COMPLETED' %}
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-undo me-2"></i>Historial de Restauraciones
            </div>
            <div class="card-body">
                {% if restore_logs %}
                {% for log in restore_logs %}
                <div class="restore-log restore-log-{{ log.status|lower }}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">
                            <span class="badge status-badge status-{{ log.status|lower }}">
                                {{ log.get_status_display }}
                            </span>
                            Restauración #{{ log.id }}
                        </h5>
                        <small>{{ log.started_at|date:"d/m/Y H:i" }}</small>
                    </div>
                    <p><strong>Restaurado por:</strong> {{ log.restored_by.username }}</p>
                    {% if log.completed_at %}
                    <p><strong>Finalizado:</strong> {{ log.completed_at|date:"d/m/Y H:i:s" }}</p>
                    {% endif %}
                    
                    {% if log.log_output %}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#logOutput{{ log.id }}">
                            Ver Detalles <i class="fas fa-chevron-down ms-1"></i>
                        </button>
                        <div class="collapse mt-2" id="logOutput{{ log.id }}">
                            <div class="log-output">{{ log.log_output }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="alert alert-light">
                    <i class="fas fa-info-circle me-2"></i>Este respaldo nunca ha sido restaurado.
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si el respaldo está en progreso
        {% if backup.status == 'IN_PROGRESS' %}
        // Actualizar estado del respaldo cada 5 segundos
        const statusInterval = setInterval(function() {
            fetch('{% url "respaldos:backup_status" backup.id %}')
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'IN_PROGRESS') {
                        // Actualizar la página para mostrar el estado actualizado
                        clearInterval(statusInterval);
                        window.location.reload();
                    }
                });
        }, 5000);
        {% endif %}
    });
</script>
{% endblock %}
