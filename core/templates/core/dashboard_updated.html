{% extends 'core/base.html' %}

{% block title %}Dashboard - App Granja{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        transition: all 0.3s ease;
    }
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .stats-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        color: var(--primary-color);
    }
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .stats-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
        <p class="lead">Bienvenido, {{ user.get_full_name|default:user.username }}. Aquí tienes un resumen de la actividad de tu granja.</p>
        {% if not estadisticas %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            No se pudieron cargar todas las estadísticas. Algunos datos pueden no estar disponibles.
        </div>
        {% endif %}
        <hr>
    </div>
</div>

<!-- Tarjetas de estadísticas rápidas -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="{% url 'admin:produccion_lote_changelist' %}" class="text-decoration-none">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-layer-group stats-icon"></i>
                    <div class="stats-number">
                        {% if estadisticas and estadisticas.inventario %}
                            {{ estadisticas.inventario.total_lotes|default:'0' }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="stats-label">Lotes Totales</div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="{% url 'produccion:lista_lotes' %}?estado=ACTIVO" class="text-decoration-none">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle stats-icon text-success"></i>
                    <div class="stats-number">
                        {% if estadisticas and estadisticas.inventario %}
                            {{ estadisticas.inventario.lotes_activos|default:'0' }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="stats-label">Lotes Activos</div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="{% url 'admin:inventario_alimento_changelist' %}" class="text-decoration-none">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-drumstick-bite stats-icon text-warning"></i>
                    <div class="stats-number">
                        {% if estadisticas and estadisticas.inventario %}
                            {{ estadisticas.inventario.total_alimentos|default:'0' }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="stats-label">Alimentos</div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <a href="{% url 'inventario:lista_vacunas' %}" class="text-decoration-none">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-syringe stats-icon text-danger"></i>
                    <div class="stats-number">
                        {% if estadisticas and estadisticas.inventario %}
                            {{ estadisticas.inventario.total_vacunas|default:'0' }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="stats-label">Vacunas</div>
                </div>
            </div>
        </a>
    </div>
</div>

<div class="row">
    <!-- Acceso rápido a módulos -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-th me-2"></i>Acceso Rápido
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{% url 'admin:produccion_lote_changelist' %}" class="text-decoration-none">
                            <div class="p-3 rounded bg-light">
                                <i class="fas fa-layer-group fa-2x text-primary mb-2"></i>
                                <h5>Lotes</h5>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{% url 'admin:inventario_alimento_changelist' %}" class="text-decoration-none">
                            <div class="p-3 rounded bg-light">
                                <i class="fas fa-drumstick-bite fa-2x text-success mb-2"></i>
                                <h5>Alimentos</h5>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{% url 'admin:ventas_venta_changelist' %}" class="text-decoration-none">
                            <div class="p-3 rounded bg-light">
                                <i class="fas fa-shopping-cart fa-2x text-danger mb-2"></i>
                                <h5>Ventas</h5>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{% url 'reportes:panel_reportes' %}" class="text-decoration-none">
                            <div class="p-3 rounded bg-light">
                                <i class="fas fa-chart-bar fa-2x text-info mb-2"></i>
                                <h5>Reportes</h5>
                            </div>
                        </a>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <h5 class="mb-3"><i class="fas fa-tools me-2"></i>Herramientas y Gestión</h5>
                
                <div class="row text-center">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{% url 'bot:chat' %}" class="text-decoration-none">
                            <div class="p-3 rounded bg-light">
                                <i class="fas fa-robot fa-2x text-success mb-2"></i>
                                <h5>Asistente Virtual</h5>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{% url 'faq:faq_list' %}" class="text-decoration-none">
                            <div class="p-3 rounded bg-light">
                                <i class="fas fa-question-circle fa-2x text-info mb-2"></i>
                                <h5>Preguntas Frecuentes</h5>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{% url 'wiki:wiki_home' %}" class="text-decoration-none">
                            <div class="p-3 rounded bg-light">
                                <i class="fas fa-book fa-2x text-warning mb-2"></i>
                                <h5>Wiki</h5>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{% url 'core:perfil_usuario' %}" class="text-decoration-none">
                            <div class="p-3 rounded bg-light">
                                <i class="fas fa-user-circle fa-2x text-danger mb-2"></i>
                                <h5>Mi Perfil</h5>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Producción -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-egg me-2"></i>Producción de Huevos (Últimas Semanas)
            </div>
            <div class="card-body">
                {% if estadisticas.produccion.datos %}
                <div class="chart-container">
                    <canvas id="produccionChart"></canvas>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        No hay datos de producción disponibles para mostrar.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Gráfico de Mortalidad -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Mortalidad (últimas 4 semanas)
            </div>
            <div class="card-body">
                {% if estadisticas and estadisticas.mortalidad and estadisticas.mortalidad.labels %}
                    <div class="chart-container">
                        <canvas id="mortalidadChart"></canvas>
                    </div>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        No hay datos de mortalidad disponibles para mostrar.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Ventas -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-dollar-sign me-2"></i>Ventas (Últimos Meses)
            </div>
            <div class="card-body">
                {% if estadisticas.ventas.datos %}
                <div class="chart-container">
                    <canvas id="ventasChart"></canvas>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <p>No hay datos de ventas disponibles.</p>
                    <a href="{% url 'admin:ventas_venta_add' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i>Nueva Venta
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Gráfico de Tipos de Huevo -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-egg me-2"></i>Distribución por Tipo de Huevo
            </div>
            <div class="card-body">
                {% if estadisticas.tipos_huevo.datos %}
                <div class="chart-container">
                    <canvas id="tiposHuevoChart"></canvas>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                    <p>No hay datos de tipos de huevo disponibles.</p>
                    <a href="{% url 'admin:produccion_seguimientodiario_add' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i>Nuevo Seguimiento
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Colores
        const primaryColor = '#4caf50';
        const secondaryColor = '#ff9800';
        const successColor = '#28a745';
        const dangerColor = '#dc3545';
        const warningColor = '#ffc107';
        const infoColor = '#17a2b8';
        const lightColor = '#f8f9fa';
        const darkColor = '#343a40';

        // Gráfico de Producción
        const produccionCtx = document.getElementById('produccionChart')?.getContext('2d');
        if (produccionCtx && {{ estadisticas.produccion.labels|default:'[]'|safe }}.length > 0) {
            try {
                new Chart(produccionCtx, {
                    type: 'line',
                    data: {
                        labels: {{ estadisticas.produccion.labels|default:'[]'|safe }},
                        datasets: [{
                            label: 'Huevos Producidos',
                            data: {{ estadisticas.produccion.datos|default:'[]'|safe }},
                            backgroundColor: 'rgba(76, 175, 80, 0.2)',
                            borderColor: primaryColor,
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad de Huevos'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al cargar el gráfico de producción:', error);
            }
        }

        // Gráfico de Mortalidad
        const mortalidadCtx = document.getElementById('mortalidadChart')?.getContext('2d');
        if (mortalidadCtx && {{ estadisticas.mortalidad.labels|default:'[]'|safe }}.length > 0) {
            try {
                new Chart(mortalidadCtx, {
                    type: 'bar',
                    data: {
                        labels: {{ estadisticas.mortalidad.labels|default:'[]'|safe }},
                        datasets: [{
                            label: 'Mortalidad',
                            data: {{ estadisticas.mortalidad.datos|default:'[]'|safe }},
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: dangerColor,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Aves'
                                },
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al cargar el gráfico de mortalidad:', error);
            }
        }

        // Gráfico de Tipos de Huevo
        const tiposHuevoCtx = document.getElementById('tiposHuevoChart')?.getContext('2d');
        if (tiposHuevoCtx && {{ estadisticas.tipos_huevo.labels|default:'[]'|safe }}.length > 0) {
            try {
                new Chart(tiposHuevoCtx, {
                    type: 'doughnut',
                    data: {
                        labels: {{ estadisticas.tipos_huevo.labels|default:'[]'|safe }},
                        datasets: [{
                            data: {{ estadisticas.tipos_huevo.datos|default:'[]'|safe }},
                            backgroundColor: [
                                primaryColor,
                                secondaryColor,
                                infoColor,
                                warningColor,
                                successColor,
                                dangerColor
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al cargar el gráfico de tipos de huevo:', error);
            }
        }
    });
</script>
{% endblock %}
